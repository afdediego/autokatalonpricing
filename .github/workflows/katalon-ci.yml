name: Ejecutar pruebas Katalon

on:
  schedule:
    - cron: '0 21 */7 * *' # Cada 7 días a las 21:00 (hora UTC)
  workflow_dispatch: # Para permitir ejecución manual

jobs:
  run-katalon-tests:
    runs-on: ubuntu-20.04

    steps:
      # Paso 1: Checkout código fuente
      - name: Checkout código fuente
        uses: actions/checkout@v3

      # Paso 2: Construir y ejecutar Docker
      - name: Construir y ejecutar Docker
        env:
          DOCKER_BUILDKIT: 1
        run: |
          docker build --platform linux/amd64 -t katalon-test -f .github/Dockerfile .
          docker run --rm \
            --platform linux/amd64 \
            --privileged \
            --cap-add=NET_ADMIN \
            --device=/dev/net/tun \
            -e VPN_PASSWORD=${{ secrets.VPN_PASSWORD }} \
            -e KATALON_API_KEY=${{ secrets.KATALON_API_KEY }} \
            -v $(pwd):/katalon/katalon/source \
            -v $(pwd)/Reports:/katalon/katalon/Reports \
            katalon-test

      # Paso 3: Subir resultados al repositorio
      - name: Subir resultados
        if: always()  # Ejecutar incluso si los tests fallan
        run: |
          git config --global user.name "afdediego"
          git config --global user.email "afdediego@gmail.com"
          git add Reports/
          git commit -m "Resultados de las pruebas [skip ci]" || echo "No hay cambios que commitear"
          git push || echo "No hay cambios que pushear"
